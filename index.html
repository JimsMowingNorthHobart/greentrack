<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GreenTrack Scheduler</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#16794b"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    body { background:#f7faf9; }
    header { margin-bottom:.5rem; }
    .tabs { display:flex; gap:.5rem; flex-wrap:wrap; }
    .tabs button[role="tab"] { border:1px solid #e6e8ef; background:#fff; }
    .active { outline:2px solid #1f7a1f33; }
    #calendar { max-width:1100px; margin:0 auto; background:#fff; padding:8px; border-radius:12px; border:1px solid #e6e8ef; }
    #map { height:75vh; border-radius:12px; border:1px solid #e6e8ef; }
    table { background:#fff; border-radius:12px; }
    .small { font-size:.9rem; color:#667085; }
    .right { text-align:right; }
    .pill { border:1px solid #e6e8ef; border-radius:10px; padding:.35rem .6rem; background:#fff; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .badge { background:#eaf6ea; color:#1f7a1f; padding:.2rem .5rem; border-radius:999px; font-weight:700; font-size:.8rem; }
    .route-panel { background:#fff; border:1px solid #e6e8ef; border-radius:12px; padding:12px; }
    .nowrap { white-space:nowrap; }
    .muted { color:#8a94a6; }
  </style>
</head>
<body>
<header class="container">
  <nav>
    <ul>
      <li><strong>GreenTrack Scheduler</strong></li>
    </ul>
    <ul class="tabs">
      <li><button role="tab" id="tab-dashboard" class="active">Dashboard</button></li>
      <li><button role="tab" id="tab-clients">Clients</button></li>
      <li><button role="tab" id="tab-calendar">Calendar</button></li>
      <li><button role="tab" id="tab-map">Map</button></li>
      <li><button role="tab" id="tab-settings">Settings</button></li>
    </ul>
  </nav>
</header>

<main class="container">

  <!-- Dashboard -->
  <section id="panel-dashboard">
    <div class="grid2">
      <article class="route-panel">
        <h4>Route Optimisation</h4>
        <div class="grid2">
          <label>Vehicle/Employee
            <input id="route-filter" placeholder="e.g., Ute-1 or John">
          </label>
          <label>Date
            <input id="route-date" type="date">
          </label>
        </div>
        <div class="grid2">
          <label class="pill"><input type="checkbox" id="route-limit-day" checked> Only jobs scheduled on selected date</label>
          <label class="pill"><input type="checkbox" id="route-start-first"> Keep first stop fixed</label>
        </div>
        <div class="grid2">
          <button id="btn-optimise">Optimise Route</button>
          <button id="btn-open-gmaps" class="secondary">Open in Google Maps</button>
        </div>
        <small class="muted">Optimiser uses Nearest-Neighbor + 2-Opt (great for 5–60 stops). Distances use straight-line for ordering; navigation uses Google Maps when opened.</small>
        <div id="route-list" style="margin-top:.75rem;"></div>
      </article>

      <article>
        <h4>Live Sheet Status</h4>
        <p class="small">Source: Google Sheet <code>1-tWXKILRtkFj_ebX1k9DikSQu2CDKByiLp8tg1uQaVY</code></p>
        <div class="grid2">
          <div>
            <strong>Total clients</strong>
            <p><span id="stat-total" class="badge">0</span></p>
          </div>
          <div>
            <strong>With coordinates</strong>
            <p><span id="stat-geo" class="badge">0</span></p>
          </div>
        </div>
        <details>
          <summary>Last fetch log</summary>
          <pre id="log" style="max-height:40vh; overflow:auto; background:#0b1021; color:#d2e0ff; padding:8px; border-radius:8px;"></pre>
        </details>
      </article>
    </div>
  </section>

  <!-- Clients -->
  <section id="panel-clients" hidden>
    <h3>Clients <span class="badge" id="client-count">0</span></h3>
    <div class="grid2">
      <input id="filter" placeholder="Search by name, suburb, vehicle, employee, frequency…">
      <div class="right">
        <button id="btn-backup" class="secondary">Backup (JSON)</button>
      </div>
    </div>
    <div style="overflow:auto; max-height:65vh; margin-top:.5rem;">
      <table id="client-table">
        <thead>
          <tr>
            <th>Name</th><th>Address</th><th>Phone</th><th>Email</th>
            <th>Frequency</th><th>Vehicle</th><th>Employee</th>
            <th>Start Date</th><th>Notes</th><th class="nowrap">Lat</th><th class="nowrap">Lng</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Calendar -->
  <section id="panel-calendar" hidden>
    <div class="grid2">
      <h3>Calendar</h3>
      <div class="right">
        <label class="pill"><input type="checkbox" id="toggle-assign" checked> Show employee/vehicle</label>
        <label>View <select id="cal-view">
          <option value="dayGridMonth">Month</option>
          <option value="timeGridWeek">Week</option>
          <option value="listWeek">List (Week)</option>
        </select></label>
      </div>
    </div>
    <div id="calendar"></div>
  </section>

  <!-- Map -->
  <section id="panel-map" hidden>
    <div class="grid2">
      <h3>Map</h3>
      <div class="right">
        <label class="pill"><input type="checkbox" id="use-clusters" checked> Cluster pins</label>
      </div>
    </div>
    <div id="map"></div>
  </section>

  <!-- Settings -->
  <section id="panel-settings" hidden>
    <h3>Settings</h3>
    <article>
      <h4>Sheet</h4>
      <label>Google Sheet ID
        <input id="sheet-id" value="1-tWXKILRtkFj_ebX1k9DikSQu2CDKByiLp8tg1uQaVY" placeholder="Paste your sheet id">
      </label>
      <div class="grid2">
        <button id="btn-reload">Reload from Sheet</button>
        <button id="btn-save-id" class="secondary">Save as default</button>
      </div>
      <small class="small">If you ever change sheets, paste the new ID and click “Save as default”.</small>
    </article>
    <article>
      <h4>Geocoding</h4>
      <label class="pill"><input type="checkbox" id="auto-geocode"> Auto geocode missing coordinates (Nominatim)</label>
      <label>Country bias <input id="country-code" placeholder="AU"></label>
    </article>
  </section>

</main>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// ---------- Helpers ----------
function $(id){return document.getElementById(id);}
function el(t,a={},kids=[]){const e=document.createElement(t);Object.entries(a).forEach(([k,v])=>k==='class'?e.className=v:e.setAttribute(k,v));kids.forEach(c=>e.appendChild(typeof c==='string'?document.createTextNode(c):c));return e;}
function log(m){const L=$("log"); if(L) L.textContent+=(dayjs().format("HH:mm:ss")+"  "+m+"\\n");}
function hav(a,b){const R=6371,toR=x=>x*Math.PI/180;const dLat=toR(b.lat-a.lat),dLng=toR(b.lng-a.lng);const s=Math.sin(dLat/2)**2+Math.cos(toR(a.lat))*Math.cos(toR(b.lat))*Math.sin(dLng/2)**2;return 2*R*Math.asin(Math.sqrt(s));}

// ---------- State ----------
const LS_SHEET="gt_sheet_id";
let SHEET_ID=localStorage.getItem(LS_SHEET) || "1-tWXKILRtkFj_ebX1k9DikSQu2CDKByiLp8tg1uQaVY";
let clients=[];
let cal,map,markerLayer,routeLine;

// ---------- Tabs ----------
const panels={"tab-dashboard":"panel-dashboard","tab-clients":"panel-clients","tab-calendar":"panel-calendar","tab-map":"panel-map","tab-settings":"panel-settings"};
Object.keys(panels).forEach(id=>{
  $(id).addEventListener("click",()=>{
    Object.keys(panels).forEach(k=>{$(k).classList.toggle("active",k===id); $(panels[k]).hidden=(k!==id);});
    if(id==="tab-calendar") setTimeout(renderCalendar,60);
    if(id==="tab-map") setTimeout(renderMap,60);
    if
