<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GreenTrack Scheduler – Drag & Drop</title>
  <style>
    :root{--green:#2a9d8f;--deep:#264653;--bg:#f4f6f8;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#222}
    nav{background:var(--green);color:#fff;padding:12px 16px;display:flex;gap:18px;flex-wrap:wrap;align-items:center}
    nav a{color:#fff;text-decoration:none;font-weight:700}
    nav a:hover{text-decoration:underline}
    .container{padding:18px;max-width:1200px;margin:0 auto}
    h1{color:var(--deep);margin:0 0 8px}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
    .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-weight:600}
    input,button{padding:10px 12px;border:1px solid #d0d7de;border-radius:8px}
    input{width:100%}
    button{background:var(--green);color:#fff;border:none;cursor:pointer}
    button.ghost{background:#e9f6f4;color:#0b5349;border:1px solid #cde7e3}
    button:hover{filter:brightness(.98)}
    .status{font-size:14px;color:#555}
    .pill{display:inline-block;padding:6px 10px;border-radius:20px;background:#eef6ff;color:#0b3d91;font-size:12px;font-weight:600}
    .day{min-height:130px;display:flex;flex-direction:column;gap:8px}
    .day-header{display:flex;justify-content:space-between;align-items:center;color:#415a77;font-weight:700}
    .job{padding:8px;border:1px solid #e6e8eb;border-radius:8px;background:#fff;cursor:grab}
    .job.dragging{opacity:.6}
    .drop-ok{outline:2px dashed var(--green)}
    .muted{opacity:.65}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}.two{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <nav>
    <a href="#dashboard">Dashboard</a>
    <a href="#clients">Clients</a>
    <a href="#calendar">Calendar</a>
    <a href="#map">Map</a>
    <a href="#settings">Settings</a>
  </nav>
  <div class="container">
    <section id="calendar" class="card">
      <div class="flex" style="justify-content:space-between">
        <h1>Calendar (Drag jobs onto a date)</h1>
        <div class="flex">
          <button class="ghost" id="prevBtn">◀ Previous</button>
          <span class="pill" id="rangeLabel">Loading…</span>
          <button class="ghost" id="nextBtn">Next ▶</button>
        </div>
      </div>
      <div id="calendarGrid" class="grid" aria-live="polite"></div>
    </section>

    <section id="settings" class="card">
      <h1>Settings</h1>
      <div class="two">
        <div>
          <label for="sheetId">Google Sheet ID</label>
          <input id="sheetId" placeholder="e.g. 1-tWXKILRtkFj_..." />
        </div>
        <div>
          <label for="scriptUrl">Write-back URL (Apps Script Web App)</label>
          <input id="scriptUrl" placeholder="https://script.google.com/.../exec" />
        </div>
      </div>
      <div class="row">
        <button id="saveBtn">Save</button>
        <button id="reloadBtn" class="ghost">Reload from Sheet</button>
        <span class="status" id="status">Not connected</span>
      </div>
      <p class="muted">Tip: To enable write-back (when you drop a job on a new date), deploy the Apps Script Web App below and paste its URL here.</p>
    </section>

    <section class="card">
      <h1>Enable Write-Back (Optional)</h1>
      <p>1) In your Google Sheet → <b>Extensions → Apps Script</b> → paste this code → <b>Deploy → New deployment → Web app</b> → Who has access: <b>Anyone</b>. Copy the Web App URL and paste it into <b>Settings → Write-back URL</b>.</p>
<pre><code>// ==== Google Apps Script (Web App) ====
// File &gt; Project Settings: Set Time zone to your region
// Deploy with access: Anyone

function doPost(e){
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  };
  try{
    const body = JSON.parse(e.postData.contents||'{}');
    const {sheetId, sheetName='Calendar', jobId, rowIndex, newDate} = body;
    if(!sheetId || !newDate) return ContentService.createTextOutput(JSON.stringify({ok:false,error:'Missing sheetId/newDate'})).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
    const ss = SpreadsheetApp.openById(sheetId);
    const sh = ss.getSheetByName(sheetName);
    if(!sh) return ContentService.createTextOutput(JSON.stringify({ok:false,error:'No sheet named '+sheetName})).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);

    // Find columns
    const lastCol = sh.getLastColumn();
    const headersRow = sh.getRange(1,1,1,lastCol).getValues()[0].map(String);
    const dateCol = headersRow.findIndex(h=>h.trim().toLowerCase()==='date')+1;
    const idCol = headersRow.findIndex(h=>h.trim().toLowerCase()==='job id')+1; // optional
    if(dateCol===0) return ContentService.createTextOutput(JSON.stringify({ok:false,error:'"Date" column not found'})).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);

    let targetRow = 0;
    if(idCol && jobId){
      const rng = sh.getRange(2,idCol,sh.getLastRow()-1,1).getValues();
      for(let i=0;i<rng.length;i++){ if(String(rng[i][0])===String(jobId)){ targetRow = i+2; break; } }
    }
    if(!targetRow && rowIndex){ targetRow = rowIndex; }
    if(!targetRow) return ContentService.createTextOutput(JSON.stringify({ok:false,error:'Row not found (need Job ID or rowIndex)'})).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);

    // Write new ISO date
    const d = new Date(newDate);
    if(isNaN(d)) return ContentService.createTextOutput(JSON.stringify({ok:false,error:'Invalid date'})).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
    sh.getRange(targetRow, dateCol).setValue(Utilities.formatDate(d, Session.getScriptTimeZone(), 'yyyy-MM-dd'));

    return ContentService.createTextOutput(JSON.stringify({ok:true,row:targetRow})).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
  }catch(err){
    return ContentService.createTextOutput(JSON.stringify({ok:false,error:String(err)})).setMimeType(ContentService.MimeType.JSON).setHeaders(headers);
  }
}

function doOptions(){
  return ContentService.createTextOutput('').setMimeType(ContentService.MimeType.TEXT).setHeaders({
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  });
}
</code></pre>
      <p>2) (Optional but recommended) Add a <b>Job ID</b> column to your <b>Calendar</b> tab. The app will use that for precise updates. If missing, it will fall back to row number.</p>
    </section>
  </div>

  <script>
    // ---- Utilities ----
    const qs = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>[...el.querySelectorAll(s)];
    const fmtISO = (d)=> new Date(d.getFullYear(),d.getMonth(),d.getDate()).toISOString().slice(0,10);

    // ---- State ----
    let state = {
      startDate: new Date(), // first day shown
      days: 28,
      sheetId: localStorage.getItem('sheetId')||'',
      scriptUrl: localStorage.getItem('scriptUrl')||'',
      calendar: [], // jobs
      headers: [],
    };

    // ---- Settings wiring ----
    function applySettingsUI(){
      qs('#sheetId').value = state.sheetId;
      qs('#scriptUrl').value = state.scriptUrl;
      updateStatus();
    }
    function updateStatus(msg){
      qs('#status').textContent = msg || (state.sheetId?`Sheet linked: ${state.sheetId.slice(0,8)}…`:'Not connected');
    }

    qs('#saveBtn').addEventListener('click',()=>{
      state.sheetId = qs('#sheetId').value.trim();
      state.scriptUrl = qs('#scriptUrl').value.trim();
      localStorage.setItem('sheetId', state.sheetId);
      localStorage.setItem('scriptUrl', state.scriptUrl);
      updateStatus('Saved ✓');
    });
    qs('#reloadBtn').addEventListener('click',()=>loadFromSheet());
    qs('#prevBtn').addEventListener('click',()=>{ state.startDate.setDate(state.startDate.getDate()-28); renderCalendar(); placeJobs(); });
    qs('#nextBtn').addEventListener('click',()=>{ state.startDate.setDate(state.startDate.getDate()+28); renderCalendar(); placeJobs(); });

    // ---- Fetch from Google Sheets (GViz JSON) ----
    async function fetchSheetJSON(sheetName){
      if(!state.sheetId) throw new Error('No Sheet ID saved');
      const url = `https://docs.google.com/spreadsheets/d/${state.sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(url, {cache:'no-store'});
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}')+1));
      const cols = json.table.cols.map(c=>c.label);
      const rows = json.table.rows.map(r=>r.c? r.c.map(c=>c?c.v:''): []);
      return {cols, rows};
    }

    function rowsToObjects(cols, rows){
      return rows.map(r=>{
        const o={};
        cols.forEach((c,i)=>{ o[c]=r[i]===undefined? '': r[i]; });
        return o;
      });
    }

    async function loadFromSheet(){
      try{
        updateStatus('Loading…');
        const cal = await fetchSheetJSON('Calendar');
        state.headers = cal.cols;
        const objs = rowsToObjects(cal.cols, cal.rows);
        // Normalize keys
        const keys = keyIndex(cal.cols);
        state.calendar = objs.map((o, idx)=>({
          rowIndex: idx+2, // 1-based sheet rows; +1 header
          jobId: o['Job ID']||'',
          date: toISO(o['Date']),
          client: o['Client']||'',
          service: o['Service']||'',
          employee: o['Employee']||'',
          vehicle: o['Vehicle']||'',
          notes: o['Notes']||''
        }));
        renderCalendar();
        placeJobs();
        updateStatus(`Loaded ${state.calendar.length} jobs ✓`);
      }catch(err){
        console.error(err);
        updateStatus('Error loading sheet. Check sharing and Sheet ID.');
      }
    }

    function keyIndex(cols){
      const map={};
      cols.forEach((c,i)=> map[c.toLowerCase()]=i );
      return map;
    }

    function toISO(v){
      if(!v) return '';
      if(typeof v === 'number'){ // GViz sometimes gives serial date
        const base = new Date(Date.UTC(1899,11,30));
        const d = new Date(base.getTime() + v*86400000);
        return fmtISO(d);
      }
      const d = new Date(v);
      return isNaN(d)? '': fmtISO(d);
    }

    // ---- Calendar render ----
    function renderCalendar(){
      const grid = qs('#calendarGrid');
      grid.innerHTML = '';
      const start = new Date(state.startDate.getFullYear(), state.startDate.getMonth(), state.startDate.getDate());
      const end = new Date(start); end.setDate(start.getDate()+state.days-1);
      qs('#rangeLabel').textContent = `${fmtISO(start)} → ${fmtISO(end)}`;

      for(let i=0;i<state.days;i++){
        const d = new Date(start); d.setDate(start.getDate()+i);
        const day = document.createElement('div');
        day.className='card day';
        day.dataset.date = fmtISO(d);
        day.innerHTML = `<div class="day-header"><span>${d.toLocaleDateString(undefined,{weekday:'short'})}</span><span>${fmtISO(d)}</span></div><div class="slot"></div>`;
        makeDroppable(day);
        grid.appendChild(day);
      }
    }

    function placeJobs(){
      // Clear existing
      qsa('.slot').forEach(el=>el.innerHTML='');
      for(const job of state.calendar){
        if(!job.date) continue;
        const day = qsa(`.day[data-date="${job.date}"]`)[0];
        if(!day) continue;
        const card = document.createElement('div');
        card.className='job';
        card.draggable = true;
        card.dataset.jobId = job.jobId||'';
        card.dataset.rowIndex = job.rowIndex;
        card.dataset.date = job.date;
        card.innerHTML = `<b>${job.client}</b><br><small>${job.service||'Service'}</small>`;
        makeDraggable(card);
        day.querySelector('.slot').appendChild(card);
      }
    }

    // ---- Drag & Drop ----
    function makeDraggable(el){
      el.addEventListener('dragstart', ev=>{
        el.classList.add('dragging');
        ev.dataTransfer.setData('text/plain', JSON.stringify({jobId: el.dataset.jobId, rowIndex: Number(el.dataset.rowIndex)}));
      });
      el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
    }

    function makeDroppable(dayEl){
      dayEl.addEventListener('dragover', ev=>{ ev.preventDefault(); dayEl.classList.add('drop-ok'); });
      dayEl.addEventListener('dragleave', ()=> dayEl.classList.remove('drop-ok'));
      dayEl.addEventListener('drop', async ev=>{
        ev.preventDefault(); dayEl.classList.remove('drop-ok');
        const payload = JSON.parse(ev.dataTransfer.getData('text/plain'));
        const newDate = dayEl.dataset.date;
        await handleDropUpdate(payload, newDate);
      });
    }

    async function handleDropUpdate({jobId,rowIndex}, newDate){
      // Update UI immediately
      const dragged = document.querySelector(`.job[data-row-index="${rowIndex}"]`) || document.querySelector(`.job[data-job-id="${CSS.escape(jobId||'')}"]`);
      if(dragged){ dragged.dataset.date = newDate; }

      // Try write-back if script URL provided
      if(state.scriptUrl){
        try{
          updateStatus('Updating…');
          const res = await fetch(state.scriptUrl, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({sheetId: state.sheetId, sheetName:'Calendar', jobId, rowIndex, newDate})});
          const j = await res.json();
          if(j.ok){ updateStatus(`Updated ✓ Row ${j.row}`); }
          else { updateStatus('Write failed: '+j.error); }
        }catch(err){ updateStatus('Write failed (network/CORS)'); }
      } else {
        updateStatus('Moved locally. To save to Sheet, add Write-back URL in Settings.');
      }

      // Refresh view from sheet after write (optional):
      // await loadFromSheet();
      placeJobs();
    }

    // ---- Init ----
    (async function init(){
      applySettingsUI();
      renderCalendar();
      if(state.sheetId){ await loadFromSheet(); }
    })();
  </script>
</body>
</html>
